## Produção Mensal de Gás na Bahia 2000 a 2022

# Lista de pacotes necessários
# Verifica e instala os pacotes necessários para a análise
pacotes <- c("forecast", "ggplot2", "readxl", "dplyr", "tidyr", "lubridate", "neuralnet", "tidyverse")

# Verificando se cada pacote está instalado e, se não estiver, instalando-o
for (pacote in pacotes) {
  if (!requireNamespace(pacote, quietly = TRUE)) {
    install.packages(pacote)
  }
}

# Carregando as bibliotecas necessárias
# Carrega os pacotes necessários para a execução do código
lapply(pacotes, library, character.only = TRUE)

# Lendo os dados da planilha Excel e criando um dataframe
# Lê os dados do Excel e organiza em um formato mais adequado para a análise
dados <- read_xlsx("C:/Users/emanu/OneDrive/Área de Trabalho/trabalho TCC/ESTUDOS_R/Historico_Prod_ Gas_Bahia/producao_gas_natural_m3.xlsx")

# Transformando os dados usando pivot_longer para derreter as colunas de anos
# Reorganiza os dados para que cada linha represente um mês de um determinado ano
dados_long <- dados %>%
  pivot_longer(cols = -Mes, names_to = "Ano", values_to = "Producao") %>%
  mutate(MesAno = paste(Mes, Ano, sep = "-"))

# Criando a coluna MesAno como uma combinação de mês e ano
# Converte a coluna 'MesAno' em um formato de data
dados_long <- dados_long %>%
  mutate(MesAno = as.Date(paste0(Ano, "-", Mes, "-01"), format = "%Y-%b-%d"))

# Remover linhas com valores ausentes
# Remove dados que estejam incompletos
dados_long <- na.omit(dados_long)

# Filtrar valores dentro do intervalo esperado
# Filtra os dados para garantir que apenas valores não negativos sejam considerados
dados_long <- dados_long %>% filter(Producao >= 0)

# Criando a Série Temporal usando o pacote 'ts'
# Cria a série temporal para a análise
Serie_Temporal_Mensal <- ts(dados_long$Producao, start = c(2000, 1), frequency = 12)

# 1 - Análise exploratória
# Criando um gráfico de linha da série temporal
# Visualiza a série temporal para entender o comportamento ao longo do tempo
ggplot(dados_long, aes(x = MesAno, y = Producao)) + 
  geom_line() + 
  labs(title = "Histórico da Produção Mensal de Gás Natural na Bahia", y = "Produção (10³ m³)", x = "MesAno")

# 2 - Análise de Sazonalidade e Padrões
# Realizando a decomposição da série temporal e plotando o resultado
# Decompõe a série em componentes de tendência, sazonalidade e resíduos
decomp <- decompose(Serie_Temporal_Mensal)
autoplot(decomp)

# 3 - Aplicando médias móveis
# Reordenando os dados pelo MesAno
# Organiza os dados para aplicar a média móvel
dados_long <- dados_long %>% 
  arrange(MesAno) 

# Calculando médias móveis com janelas de tamanho 3
# Suaviza a série temporal para identificar melhor as tendências
dados_MediaMovel <- ma(dados_long$Producao, order = 3, centre = TRUE)

# Criando um novo conjunto de dados com MesAno e Médias Móveis
# Cria um novo dataframe para armazenar as médias móveis
dados_medias_movel <- data.frame(MesAno = dados_long$MesAno, MediaMovel = dados_MediaMovel)

# Remover linhas com valores ausentes no conjunto de médias móveis
# Remove valores ausentes das médias móveis
dados_medias_movel <- na.omit(dados_medias_movel)

# Plotando gráfico com a série original e médias móveis
# Compara a série original com a série suavizada pelas médias móveis
ggplot() + 
  geom_line(data = dados_long, aes(x = MesAno, y = Producao, color = "Produção Mensal"), alpha = 0.5) + 
  geom_line(data = dados_medias_movel, aes(x = MesAno, y = MediaMovel, color = "Médias Móveis"), linewidth = 1) + 
  scale_color_manual("", 
                     breaks = c("Produção Mensal", "Médias Móveis"),
                     values = c("Produção Mensal" = "blue", "Médias Móveis" = "red")) +
  labs(title = "Produção Mensal com Médias Móveis", 
       y = "Produção (10³ m³)", 
       x = "MesAno") +
  theme_minimal()

# 4 - Modelagem com ARIMA
# Identificando automaticamente o melhor modelo ARIMA
# Ajusta o modelo ARIMA e escolhe automaticamente os melhores parâmetros
modelo_arima_mensal <- auto.arima(dados_long$Producao, trace = TRUE, approximation = FALSE)

# 4.1 - Implementar o ARIMA com os parâmetros encontrados
# Implementa o modelo ARIMA utilizando os parâmetros identificados
mod <- Arima(dados_long$Producao, order = c(2, 1, 1))

# 4.2 - Checar a qualidade do modelo
# Realiza diagnóstico dos resíduos do modelo para garantir sua adequação
checkresiduals(mod)

# 4.3 - Fazer as previsões
# Gerando previsões usando o modelo ARIMA
# Previsão para os próximos 12 meses
prev <- forecast(mod, h = 12)

# Extraindo as datas das previsões
# Cria uma sequência de datas para associar às previsões
data_previsao <- seq.Date(from = max(dados_long$MesAno) + months(1), by = "month", length.out = 12)

# Criando um dataframe para combinar datas e previsões
# Combina as datas com os valores previstos
prev_data <- data.frame(MesAno = data_previsao, Previsao = prev$mean)

# Plotando o gráfico com ggplot2
# Visualiza a série original e as previsões geradas pelo modelo ARIMA
ggplot() + 
  geom_line(data = dados_long, aes(x = MesAno, y = Producao), color = "blue") + 
  geom_line(data = prev_data, aes(x = MesAno, y = Previsao), color = "red") + 
  geom_ribbon(data = prev_data, aes(x = MesAno, ymin = prev$lower[,2], ymax = prev$upper[,2]), fill = "red", alpha = 0.2) +
  labs(title = "Previsões do Modelo ARIMA(2,1,1)", 
       y = "Produção (10³ m³)", 
       x = "MesAno") +
  theme_minimal()

# 5 - Métricas de Erro para o Modelo ARIMA

# Previsões ajustadas para o período histórico
# Usamos a função 'fitted()' para obter as previsões ajustadas (fitted values) do modelo ARIMA,
# que representam as previsões do modelo para o período em que temos dados observados.
ajuste_arima <- fitted(modelo_arima_mensal)

# Calculando o erro absoluto
# O erro absoluto é a diferença absoluta entre os valores observados e os valores previstos pelo modelo.
# Ele fornece uma medida direta de quão distante as previsões do modelo estão dos valores reais.
erro_absoluto_arima <- abs(dados_long$Producao - ajuste_arima)
dados_long_erro <- dados_long %>% mutate(erro_absoluto_arima = erro_absoluto_arima)

# Calculando o erro quadrático
# O erro quadrático é o quadrado da diferença entre os valores observados e os valores previstos pelo modelo.
# Esta métrica penaliza desvios maiores, proporcionando uma visão clara dos períodos de maior dificuldade na previsão.
erro_quadratico_arima <- (dados_long$Producao - ajuste_arima)^2
dados_long_erro <- dados_long_erro %>% mutate(erro_quadratico_arima = erro_quadratico_arima)

# Plotando o gráfico de erro absoluto para ARIMA
# Este gráfico visualiza a variação do erro absoluto ao longo do tempo, permitindo identificar os períodos
# em que o modelo ARIMA teve maior dificuldade em prever com precisão.
ggplot(data = dados_long_erro, aes(x = MesAno, y = erro_absoluto_arima)) + 
  geom_line() + 
  labs(title = "Erro Absoluto do Modelo ARIMA", 
       y = "Erro Absoluto", 
       x = "MesAno") +
  theme_minimal()

# Plotando o gráfico de erro quadrático para ARIMA
# Este gráfico visualiza o erro quadrático ao longo do tempo, destacando os períodos em que o modelo
# ARIMA teve maior dificuldade em capturar as variações da série temporal.
ggplot(data = dados_long_erro, aes(x = MesAno, y = erro_quadratico_arima)) + 
  geom_line() + 
  labs(title = "Erro Quadrático do Modelo ARIMA", 
       y = "Erro Quadrático", 
       x = "MesAno") +
  theme_minimal()

# Sobreposição dos Erros Absoluto e Quadrático para o Modelo ARIMA

# Normalizando os erros para que fiquem na mesma escala
# Isso é feito para que possamos comparar diretamente o comportamento dos dois tipos de erro ao longo do tempo.
dados_long_erro <- dados_long_erro %>%
  mutate(erro_absoluto_norm_arima = erro_absoluto_arima / max(erro_absoluto_arima, na.rm = TRUE),
         erro_quadratico_norm_arima = erro_quadratico_arima / max(erro_quadratico_arima, na.rm = TRUE))

# Criando o gráfico de sobreposição dos erros
# Este gráfico ajuda a visualizar como os dois tipos de erro (absoluto e quadrático) se comportam em conjunto,
# destacando os períodos problemáticos para o modelo ARIMA.
ggplot(data = dados_long_erro) + 
  geom_line(aes(x = MesAno, y = erro_absoluto_norm_arima, color = "Erro Absoluto Normalizado")) + 
  geom_line(aes(x = MesAno, y = erro_quadratico_norm_arima, color = "Erro Quadrático Normalizado")) + 
  labs(title = "Sobreposição dos Erros Absoluto e Quadrático do Modelo ARIMA", 
       y = "Erro Normalizado", 
       x = "MesAno") + 
  scale_color_manual("", 
                     breaks = c("Erro Absoluto Normalizado", "Erro Quadrático Normalizado"),
                     values = c("Erro Absoluto Normalizado" = "blue", "Erro Quadrático Normalizado" = "red")) +
  theme_minimal()


# 7 - Modelagem com ETS (Exponential Smoothing State Space Model)
# Modela a série temporal utilizando o modelo ETS
modelo_ets <- ets(dados_long$Producao)

# Fazendo previsões usando o modelo ETS
prev_ets <- forecast(modelo_ets, h = 12)

# Extraindo as datas das previsões
# Cria as datas associadas às previsões do modelo ETS
data_previsao_ets <- seq.Date(from = max(dados_long$MesAno) + months(1), by = "month", length.out = 12)

# Criando um dataframe para combinar datas e previsões
# Combina as previsões com as datas correspondentes
prev_data_ets <- data.frame(MesAno = data_previsao_ets, Previsao = prev_ets$mean)

# Plotando o gráfico com ggplot2
# Visualiza a série original e as previsões geradas pelo modelo ETS
ggplot() + 
  geom_line(data = dados_long, aes(x = MesAno, y = Producao), color = "blue") + 
  geom_line(data = prev_data_ets, aes(x = MesAno, y = Previsao), color = "red") + 
  geom_ribbon(data = prev_data_ets, aes(x = MesAno, ymin = prev_ets$lower[,2], ymax = prev_ets$upper[,2]), fill = "red", alpha = 0.2) +
  labs(title = "Previsões do Modelo ETS", 
       y = "Produção (10³ m³)", 
       x = "MesAno") +
  theme_minimal()


# 8 - Métricas de Erro para o Modelo ETS

# Previsões ajustadas para o período histórico
# A função 'fitted()' é usada para obter as previsões ajustadas (fitted values) do modelo ETS,
# que correspondem às previsões do modelo para o período em que já temos dados observados.
ajuste_ets <- fitted(modelo_ets)

# Calculando o erro absoluto
# O erro absoluto é a diferença absoluta entre os valores observados e os valores previstos pelo modelo.
# Ele nos dá uma ideia de quão distante as previsões do modelo estão dos valores reais.
erro_absoluto_ets <- abs(dados_long$Producao - ajuste_ets)
dados_long_erro <- dados_long %>% mutate(erro_absoluto_ets = erro_absoluto_ets)

# Calculando o erro quadrático
# O erro quadrático é o quadrado da diferença entre os valores observados e os valores previstos pelo modelo.
# Essa métrica penaliza desvios maiores, ou seja, valores em que a previsão está muito distante do valor real.
erro_quadratico_ets <- (dados_long$Producao - ajuste_ets)^2
dados_long_erro <- dados_long_erro %>% mutate(erro_quadratico_ets = erro_quadratico_ets)

# Plotando o gráfico de erro absoluto para ETS
# Este gráfico mostra como o erro absoluto varia ao longo do tempo, permitindo identificar períodos 
# onde o modelo teve maior dificuldade em prever com precisão.
ggplot(data = dados_long_erro, aes(x = MesAno, y = erro_absoluto_ets)) + 
  geom_line() + 
  labs(title = "Erro Absoluto do Modelo ETS", 
       y = "Erro Absoluto", 
       x = "MesAno") +
  theme_minimal()

# Plotando o gráfico de erro quadrático para ETS
# Este gráfico visualiza o erro quadrático ao longo do tempo, destacando períodos com grandes desvios
# entre as previsões e os valores reais, o que pode indicar a presença de outliers ou mudanças bruscas nos dados.
ggplot(data = dados_long_erro, aes(x = MesAno, y = erro_quadratico_ets)) + 
  geom_line() + 
  labs(title = "Erro Quadrático do Modelo ETS", 
       y = "Erro Quadrático", 
       x = "MesAno") +
  theme_minimal()

# Sobreposição dos Erros Absoluto e Quadrático para o Modelo ETS
# Normalizando os erros para que fiquem na mesma escala
dados_long_erro <- dados_long_erro %>%
  mutate(erro_absoluto_norm_ets = erro_absoluto_ets / max(erro_absoluto_ets, na.rm = TRUE),
         erro_quadratico_norm_ets = erro_quadratico_ets / max(erro_quadratico_ets, na.rm = TRUE))

# Criando o gráfico de sobreposição dos erros
# Este gráfico ajuda a visualizar como os dois tipos de erro se comportam em conjunto, destacando períodos problemáticos
ggplot(data = dados_long_erro) + 
  geom_line(aes(x = MesAno, y = erro_absoluto_norm_ets, color = "Erro Absoluto Normalizado")) + 
  geom_line(aes(x = MesAno, y = erro_quadratico_norm_ets, color = "Erro Quadrático Normalizado")) + 
  labs(title = "Sobreposição dos Erros Absoluto e Quadrático do Modelo ETS", 
       y = "Erro Normalizado", 
       x = "MesAno") + 
  scale_color_manual("", 
                     breaks = c("Erro Absoluto Normalizado", "Erro Quadrático Normalizado"),
                     values = c("Erro Absoluto Normalizado" = "blue", "Erro Quadrático Normalizado" = "red")) +
  theme_minimal()




# 9 - Modelagem com Regressão Linear
# Modelando a série temporal usando regressão linear
modelo_reg <- lm(Producao ~ MesAno, data = dados_long)

# Criando um novo conjunto de dados para previsões
# Gera datas futuras para as previsões usando regressão linear
novos_dados <- data.frame(MesAno = seq.Date(max(dados_long$MesAno) + 1, by = "months", length.out = 12))

# Fazendo previsões usando o modelo de regressão linear
# Calcula as previsões com base no modelo de regressão linear
prev_reg <- predict(modelo_reg, newdata = novos_dados)

# Criando um dataframe para combinar datas e previsões
# Combina as previsões com as datas correspondentes
prev_data_reg <- data.frame(MesAno = novos_dados$MesAno, Previsao = prev_reg)

# Plotando o gráfico com ggplot2
# Visualiza a série original e as previsões geradas pelo modelo de regressão linear
ggplot() + 
  geom_line(data = dados_long, aes(x = MesAno, y = Producao), color = "blue") + 
  geom_line(data = prev_data_reg, aes(x = MesAno, y = Previsao), color = "red") + 
  labs(title = "Previsões do Modelo de Regressão Linear", 
       y = "Produção (10³ m³)", 
       x = "MesAno") +
  theme_minimal()


# 10 - Métricas de Erro para o Modelo de Regressão Linear

# Previsões ajustadas para o período histórico
# Para o modelo de regressão linear, usamos a função 'predict()' para obter as previsões ajustadas (fitted values).
# Estas previsões representam os valores esperados com base no modelo linear e nos dados históricos.
ajuste_reg <- predict(modelo_reg, newdata = dados_long)

# Calculando o erro absoluto
# O erro absoluto é a diferença absoluta entre os valores observados e as previsões do modelo.
# Esta métrica é útil para entender a precisão geral do modelo de regressão linear.
erro_absoluto_reg <- abs(dados_long$Producao - ajuste_reg)
dados_long_erro <- dados_long %>% mutate(erro_absoluto_reg = erro_absoluto_reg)

# Calculando o erro quadrático
# O erro quadrático penaliza maiores desvios ao elevar ao quadrado a diferença entre os valores observados e previstos.
# É particularmente útil quando se quer destacar grandes erros de previsão.
erro_quadratico_reg <- (dados_long$Producao - ajuste_reg)^2
dados_long_erro <- dados_long_erro %>% mutate(erro_quadratico_reg = erro_quadratico_reg)

# Plotando o gráfico de erro absoluto para Regressão Linear
# Este gráfico mostra a variação do erro absoluto ao longo do tempo para o modelo de regressão linear,
# permitindo identificar períodos de maior imprecisão nas previsões.
ggplot(data = dados_long_erro, aes(x = MesAno, y = erro_absoluto_reg)) + 
  geom_line() + 
  labs(title = "Erro Absoluto do Modelo de Regressão Linear", 
       y = "Erro Absoluto", 
       x = "MesAno") +
  theme_minimal()

# Plotando o gráfico de erro quadrático para Regressão Linear
# Este gráfico visualiza o erro quadrático para o modelo de regressão linear,
# destacando períodos onde o modelo teve maior dificuldade em capturar a variabilidade dos dados.
ggplot(data = dados_long_erro, aes(x = MesAno, y = erro_quadratico_reg)) + 
  geom_line() + 
  labs(title = "Erro Quadrático do Modelo de Regressão Linear", 
       y = "Erro Quadrático", 
       x = "MesAno") +
  theme_minimal()

# Sobreposição dos Erros Absoluto e Quadrático para o Modelo de Regressão Linear
# Normalizando os erros para que fiquem na mesma escala
dados_long_erro <- dados_long_erro %>%
  mutate(erro_absoluto_norm_reg = erro_absoluto_reg / max(erro_absoluto_reg, na.rm = TRUE),
         erro_quadratico_norm_reg = erro_quadratico_reg / max(erro_quadratico_reg, na.rm = TRUE))

# Criando o gráfico de sobreposição dos erros
# Este gráfico ajuda a visualizar como os dois tipos de erro se comportam em conjunto, destacando períodos problemáticos
ggplot(data = dados_long_erro) + 
  geom_line(aes(x = MesAno, y = erro_absoluto_norm_reg, color = "Erro Absoluto Normalizado")) + 
  geom_line(aes(x = MesAno, y = erro_quadratico_norm_reg, color = "Erro Quadrático Normalizado")) + 
  labs(title = "Sobreposição dos Erros Absoluto e Quadrático do Modelo de R. Linear", 
       y = "Erro Normalizado", 
       x = "MesAno") + 
  scale_color_manual("", 
                     breaks = c("Erro Absoluto Normalizado", "Erro Quadrático Normalizado"),
                     values = c("Erro Absoluto Normalizado" = "blue", "Erro Quadrático Normalizado" = "red")) +
  theme_minimal()

